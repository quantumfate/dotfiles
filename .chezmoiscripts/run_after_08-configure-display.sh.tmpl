#!/bin/bash
set -euo pipefail

{{- if eq .chezmoi.hostname "quantum-desktop" }}

echo "==> Configuring display/VT settings for desktop..."

# 1. Add kernel parameters to Limine if missing
LIMINE_CONF="/etc/default/limine"
NEEDS_LIMINE_UPDATE=false

add_kernel_param() {
  local param="$1"
  if ! grep -q "$param" "$LIMINE_CONF" 2>/dev/null; then
    sudo sed -i "s|KERNEL_CMDLINE\[default\]+=\"\(.*\)\"|KERNEL_CMDLINE[default]+=\"\1 $param\"|" "$LIMINE_CONF"
    NEEDS_LIMINE_UPDATE=true
    echo "✓ Added '$param' to kernel cmdline"
  else
    echo "✓ '$param' already in kernel cmdline"
  fi
}

# Disable HDMI on VT so console uses only the main DP monitor
add_kernel_param "video=HDMI-A-1:d"

if [ "$NEEDS_LIMINE_UPDATE" = true ]; then
  sudo limine-update
  echo "✓ Limine config regenerated"
fi

echo "==> Desktop display configuration complete."
echo "    Reboot required for kernel parameter changes to take effect."

{{- end }}
