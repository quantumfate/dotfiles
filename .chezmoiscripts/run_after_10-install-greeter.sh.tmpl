#!/bin/bash
# chezmoi: run_once
# Sets up greetd + tuigreet (NotAShelf fork) + uwsm as the display manager.
# Idempotent: safe to re-run, only acts when needed.
#

echo "###################### Installing Tuigreet ######################"
echo ""
echo ""

if passwd -S "{{ .chezmoi.username }}" | grep -qE ' L | NP '; then
  echo "ERROR: Your user password is not set. Run: passwd $USER" >&2
  echo "Run 'su -c \"passwd -S {{ .chezmoi.username }}\"'"
  exit 1
fi

sudo -v
set -euo pipefail

GREETD_CONFIG="/etc/greetd/config.toml"
GREETER_USER="greeter"

if ! pacman -Qi greetd &>/dev/null; then
  echo "==> Installing greetd..."
  sudo pacman -S --noconfirm greetd
fi



# Check if update is needed
NEEDS_BUILD=false
if ! pacman -Qi tuigreet-notashelf-git &>/dev/null; then
  NEEDS_BUILD=true
else
  LATEST_COMMIT=$(git ls-remote https://github.com/NotAShelf/tuigreet HEAD | cut -f1)
  INSTALLED_VER=$(pacman -Q tuigreet-notashelf-git | awk '{print $2}')
  SHORT_HASH=${LATEST_COMMIT:0:7}
  if [[ "$INSTALLED_VER" != *"$SHORT_HASH"* ]]; then
    NEEDS_BUILD=true
  fi
fi

if [ "$NEEDS_BUILD" = true ]; then
  echo "==> Installing NotAShelf's tuigreet fork via makepkg..."

  # Install build dependencies
  if ! command -v cargo &>/dev/null; then
    sudo pacman -S --noconfirm rust
  fi
  if ! command -v git &>/dev/null; then
    sudo pacman -S --noconfirm git
  fi
  if ! pacman -Qi base-devel &>/dev/null; then
    sudo pacman -S --noconfirm base-devel
  fi

  PKGBUILD_DIR="/tmp/tuigreet-notashelf-git"
  rm -rf "$PKGBUILD_DIR"
  mkdir -p "$PKGBUILD_DIR"

cat > "$PKGBUILD_DIR/PKGBUILD" << 'PKGBUILD_EOF'
# Maintainer: Auto-generated for NotAShelf/tuigreet
pkgname=tuigreet-notashelf-git
pkgver=r0
pkgrel=1
pkgdesc="Stylish graphical console greeter for greetd (NotAShelf fork)"
arch=('x86_64' 'aarch64')
url="https://github.com/NotAShelf/tuigreet"
license=('GPL-3.0-only')
depends=('greetd')
makedepends=('cargo' 'git')
provides=('tuigreet')
conflicts=('tuigreet' 'greetd-tuigreet')
source=("git+https://github.com/NotAShelf/tuigreet.git")
sha256sums=('SKIP')

pkgver() {
  cd tuigreet
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd tuigreet
  export RUSTUP_TOOLCHAIN=stable
  cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
}

build() {
  cd tuigreet
  export RUSTUP_TOOLCHAIN=stable
  export CARGO_TARGET_DIR=target
  cargo build --frozen --release
}

package() {
  cd tuigreet
  install -Dm755 "target/release/tuigreet" "$pkgdir/usr/bin/tuigreet"
}
PKGBUILD_EOF

  cd "$PKGBUILD_DIR"
  makepkg -si --noconfirm
  rm -rf "$PKGBUILD_DIR"
  echo "✓ tuigreet (NotAShelf fork) updated"
else
  echo "✓ tuigreet (NotAShelf fork) already up to date"
fi

if ! command -v uwsm &>/dev/null; then
  echo "==> Installing uwsm..."
  if command -v paru &>/dev/null; then
    paru -S --noconfirm uwsm
  elif command -v yay &>/dev/null; then
    yay -S --noconfirm uwsm
  else
    echo "ERROR: No AUR helper found. Please install uwsm manually." >&2
    exit 1
  fi
fi

if ! pacman -Qi gnome-keyring &>/dev/null; then
  echo "==> Installing gnome-keyring..."
  sudo pacman -S --noconfirm gnome-keyring
fi

PAM_GREETD="/etc/pam.d/greetd"
if ! grep -q "pam_gnome_keyring" "$PAM_GREETD" 2>/dev/null; then
  echo "==> Configuring PAM for gnome-keyring auto-unlock..."
  sudo tee -a "$PAM_GREETD" >/dev/null <<'EOF'
auth     optional  pam_gnome_keyring.so
session  optional  pam_gnome_keyring.so auto_start
EOF
fi

AUTOLOGIN_OVERRIDE="/etc/systemd/system/getty@tty1.service.d/autologin.conf"
if [ -f "$AUTOLOGIN_OVERRIDE" ]; then
  echo "==> Removing systemd autologin..."
  sudo rm "$AUTOLOGIN_OVERRIDE"
  sudo systemctl daemon-reload
  sudo systemctl disable getty@tty1
fi

if ! id "$GREETER_USER" &>/dev/null; then
  echo "==> Creating greeter user..."
  sudo useradd -M -G video "$GREETER_USER"
fi

echo "==> Creating tuigreet cache directory..."
sudo mkdir -p /var/cache/tuigreet
sudo chown "$GREETER_USER:$GREETER_USER" /var/cache/tuigreet
sudo chmod 0755 /var/cache/tuigreet


WIDTH=200
WPAD=4
CPAD=2
WIDTH=120
WPAD=2
CPAD=1

echo "==> Writing greetd config..."
sudo mkdir -p /etc/greetd
sudo tee "$GREETD_CONFIG" >/dev/null <<'EOF'
[terminal]
vt = 1

[default_session]
command = "tuigreet --config /etc/tuigreet/config.toml"
user = "greeter"
EOF

echo "==> Writing tuigreet config..."
sudo mkdir -p /etc/tuigreet/
sudo tee /etc/tuigreet/config.toml >/dev/null <<'EOF'
[display]
show_time = true
greeting = "Hello Quantum!"
align_greeting = "center"
issue = false

[layout]
{{- if eq .chezmoi.hostname "quantum-desktop" }}
width = 240
window_padding = 4
container_padding = 2
{{- else }}
width = 120
window_padding = 2
container_padding = 1
{{- end }}
prompt_padding = 1

[layout.widgets]
time_position = "top"
status_position = "bottom"

[remember]
username = true
session = true
user_session = true

[user_menu]
enabled = true
min_uid = 1000
max_uid = 60000

[secret]
mode = "characters"
characters = "*"

[keybindings]
command = 2
sessions = 3
power = 12

[session]
sessions_dirs = ["/usr/share/wayland-sessions", "/usr/share/xsessions"]
xsessions_dirs = []
environments = []

[power]
use_setsid = false

[theme]
border = "bright-black"
text = "white"
time = "bright-white"
container = "black"
title = "magenta"
greet = "white"
prompt = "bright-blue"
input = "bright-cyan"
action = "cyan"
button = "red"
EOF

# Ensure systemd-vconsole-setup runs before greetd
sudo tee /etc/systemd/system/greetd.service.d/vconsole.conf >/dev/null <<'EOF'
[Unit]
After=systemd-vconsole-setup.service
Wants=systemd-vconsole-setup.service

[Service]
ExecStartPost=/usr/bin/systemctl restart systemd-vconsole-setup.service
EOF
sudo systemctl daemon-reload

for dm in sddm gdm lightdm lxdm; do
  if systemctl is-enabled "$dm" &>/dev/null; then
    echo "  Disabling $dm..."
    sudo systemctl disable "$dm"
  fi
done

sudo systemctl enable greetd

echo "==> Done. greetd with tuigreet (NotAShelf fork) + uwsm is configured."
echo "    Changes take effect on next boot (or: sudo systemctl start greetd)"
